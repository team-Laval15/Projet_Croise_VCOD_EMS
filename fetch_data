# pipelines/fetch_data.py

import os
import requests
from pipelines.utils import ensure_dir

def fetch_legacy(server, dataset, country, year, quarter, output_dir):
    """
    Télécharge le fichier legacy pour un seul pays / année / trimestre.
    """
    ensure_dir(output_dir)
    
    url = f"{server}/archived/{dataset}/{country}/{year}Q{quarter}"
    print(f"Téléchargement : {url}")
    
    try:
        response = requests.get(url)
        if response.status_code == 200 and response.text.strip():
            filename = f"{country}_{year}Q{quarter}.fasta"
            path = os.path.join(output_dir, filename)

            with open(path, "w", encoding="utf-8") as f:
                f.write(response.text.strip() + "\n")

            print(f"✔ Fichier créé : {filename}")
            return path
        else:
            print(f"⚠ Pas de données pour {country} {year}Q{quarter}")
            return None

    except Exception as e:
        print(f"Erreur téléchargement {country} {year}Q{quarter} : {e}")
        return None
