# pipelines/fetch_data.py

import requests
import os

def fetch_legacy(server, dataset, country, year, quarter, output_dir):
    """
    Télécharge les données via l'API legacy :
    {server}/archived/{dataset}/{country}/{year}Q{quarter}
    """

    trimester = f"{year}Q{quarter}"
    url = f"{server}/archived/{dataset}/{country}/{trimester}"

    try:
        response = requests.get(url, timeout=30)

        if response.status_code == 200 and response.text.strip():
            filename = f"{country}_{trimester}.fasta"
            path = os.path.join(output_dir, filename)

            with open(path, "w", encoding="utf-8") as f:
                f.write(response.text)

            print(f"✔ Téléchargé : {filename}")
            return path

        else:
            print(f"✘ Pas de données : {country} {trimester}")
            return None

    except requests.exceptions.RequestException as e:
        print(f"⚠ Erreur connexion {country} {trimester} : {e}")
        return None
