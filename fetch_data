# pipelines/fetch_data.py

import os
import requests
from pipelines.utils import ensure_dir

def fetch_legacy(server, dataset, countries, years, quarters, output_dir):
    """
    Télécharge les fichiers legacy depuis le serveur et retourne la liste des fichiers créés.

    Params:
    - server: URL du serveur
    - dataset: nom du dataset (ex: sequences)
    - countries: liste de codes pays ['FR', 'DE']
    - years: liste ou range d'années [1987, 1988]
    - quarters: liste de trimestres [1,2,3,4]
    - output_dir: dossier où sauvegarder les fichiers

    Returns:
    - fichiers téléchargés (chemins complets)
    """

    ensure_dir(output_dir)

    downloaded_files = []

    for country in countries:
        for year in years:
            for quarter in quarters:
                url = f"{server}/archived/{dataset}/{country}/{year}Q{quarter}"
                print(f"Téléchargement : {url}")
                try:
                    response = requests.get(url)
                    if response.status_code == 200 and response.text.strip():
                        filename = f"{country}_{year}Q{quarter}.fasta"
                        path = os.path.join(output_dir, filename)

                        with open(path, "w", encoding="utf-8") as f:
                            f.write(response.text.strip() + "\n")

                        print(f"✔ Fichier créé : {filename}")
                        downloaded_files.append(path)
                    else:
                        print(f"⚠ Pas de données pour {country} {year}Q{quarter}")

                except Exception as e:
                    print(f"Erreur téléchargement {country} {year}Q{quarter} : {e}")

    return downloaded_files
S
