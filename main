from pipelines.fetch_data import fetch_legacy
from pipelines.split_fasta import split_fasta
from pipelines.merge_fasta import merge_directories
from pipelines.utils import ensure_dir

# ==============================
# üîπ Param√®tres √† renseigner
# ==============================

SERVER = input("Serveur (ex: http://ton_serveur) : ").strip()
DATASET = input("Dataset (sequences, cancer, etc.) : ").strip()
COUNTRIES = input("Pays (FR, DE, etc., s√©par√©s par des virgules) : ").strip().upper().split(",")
START_YEAR = int(input("Ann√©e de d√©but : ").strip())
END_YEAR = int(input("Ann√©e de fin : ").strip())
FORMATS = input("Formats √† extraire (fasta ou csv) : ").strip().lower()

OLD_DATA_DIR = input("Dossier des anciennes donn√©es : ").strip() or "fasta_data"
TEMP_DIR = input("Dossier temporaire pour nouvelles donn√©es : ").strip() or "new_data"
SPLIT_DIR = input("Dossier pour donn√©es split√©es : ").strip() or "fasta_split"
MERGE_DIR = input("Dossier final pour fusion : ").strip() or "fasta_merge"

# ==============================
# Cr√©ation des dossiers si inexistant
# ==============================

ensure_dir(TEMP_DIR)
ensure_dir(SPLIT_DIR)
ensure_dir(MERGE_DIR)

# ==============================
# üîπ Pipeline
# ==============================

for country in COUNTRIES:
    country = country.strip()
    for year in range(START_YEAR, END_YEAR + 1):
        for quarter in range(1, 5):

            print(f"\nT√©l√©chargement : {country} {year}Q{quarter}")
            file_path = fetch_legacy(
                SERVER,
                DATASET,
                country,
                year,
                quarter,
                TEMP_DIR
            )

            # Split si fichier t√©l√©charg√© et format FASTA
            if file_path and FORMATS == "fasta":
                split_fasta(file_path, SPLIT_DIR)

# Fusion finale
merge_directories(OLD_DATA_DIR, SPLIT_DIR, MERGE_DIR)

print("\nPipeline termin√© avec succ√®s !")
print(f"Fusion des donn√©es disponibles dans : {MERGE_DIR}")
